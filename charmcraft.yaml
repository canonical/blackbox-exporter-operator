# Copyright 2026 Canonical Ltd.
# See LICENSE file for licensing details.

# This file configures Charmcraft.
# See https://juju.is/docs/sdk/charmcraft-config for guidance.

type: charm
subordinate: true
name: blackbox-exporter-operator
title: Blackbox Exporter Machine Charm
summary: Performs ICMP connectivity checks of its peers by default and supports blackbox probing with a variety of protocols.
description: |
  Blackbox exporter is a Prometheus exporter that can execute blackbox
  probes for a variety of protocols, including HTTP(s), DNS, TCP and ICMP.
  This charm operates the Blackbox Exporter snap on machines such as LXD.

links:
  # TODO: update these two lines when we register on Charmhub
  #documentation: https://discourse.charmhub.io/t/blackbox-exporter-k8s-docs-index/11728
  #website: https://charmhub.io/blackbox-exporter-k8s
  source: https://github.com/canonical/blackbox-exporter-operator
  issues: https://github.com/canonical/blackbox-exporter-operator/issues

platforms:
  ubuntu@22.04:amd64:
  ubuntu@22.04:arm64:
  ubuntu@24.04:amd64:
  ubuntu@24.04:arm64:

parts:
  charm:
    plugin: uv
    source: .
    build-snaps:
      - astral-uv

requires:
  juju-info:
    description: |
      `juju-info` provides basic compatibility with all charms.
    interface: juju-info
    scope: container

provides:
  cos-agent:
    description: |
      `cos-agent` is a dedicated relation for the Grafana agent
      and Opentelemetry Collector machine charms.
      It alows this charm to set up custom scrape jobs, logs, etc to be
      scraped by a `cos-agent`-requiring charm.
    interface: cos_agent
    scope: container
    optional: true

peers:
  peers:
    interface: blackbox_exporter_replica

config:
  options:
    config_file:
      description: |
        Supply a configuration file for Blackbox Exporter in which modules and their parameters are specified.
        The provided config file must be a valid YAML and contain a `modules` section.
        If this value is unset, the default configuration set by the snap will be used.
        Automatic connectivity checks require the ICMP module. 
        If you need automatic cross-unit connectivity checks, do NOT remove the ICMP module. 
        If your ICMP checks require DNS resolution for a target e.g. charmhub.io,
        ensure the parameter `ip_protocol_fallback` is set to `true`.
        Refer to https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md for
        more information.
      type: string
      default: |
        modules:
          http_2xx:
            prober: http
            timeout: 10s
          tcp_connect:
            prober: tcp
            timeout: 10s
          icmp:
            prober: icmp
            timeout: 10s
            icmp:
              preferred_ip_protocol: "ip4"
              ip_protocol_fallback: true

